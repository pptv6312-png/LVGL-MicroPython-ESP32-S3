name: LVGL_MicroPython For ESP32

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  LVGL: lvgl_micropython
  LVGL_REPO: https://github.com/lvgl-micropython/lvgl_micropython.git
  TZ: Asia/Shanghai

jobs:
  build-firmware:
    name: Build LVGL_MicroPython
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        config:
          - board: ESP32_GENERIC_S3
            variant: SPIRAM_OCT
            flash: 8
            display: ILI9341
            indev: FT6X36

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git wget flex bison gperf \
            python3 python3-pip python3-venv \
            cmake ninja-build ccache \
            libffi-dev libssl-dev dfu-util \
            libusb-1.0-0
          sudo timedatectl set-timezone "${{ env.TZ }}"

      - name: Clone LVGL MicroPython
        run: |
          git clone --recursive --depth=1 "${{ env.LVGL_REPO }}" "${{ env.LVGL }}"

      - name: Build firmware
        id: build
        run: |
          cd "${{ env.LVGL }}"
          
          echo "ðŸ“¦ Building for ${{ matrix.config.board }}..."
          
          # æž„å»ºå‘½ä»¤
          CMD="python3 make.py esp32 \
            BOARD=${{ matrix.config.board }} \
            BOARD_VARIANT=${{ matrix.config.variant }} \
            --flash-size=${{ matrix.config.flash }} \
            DISPLAY=${{ matrix.config.display }}"
          
          if [ -n "${{ matrix.config.indev }}" ] && [ "${{ matrix.config.indev }}" != "none" ]; then
            CMD="$CMD INDEV=${{ matrix.config.indev }}"
          fi
          
          echo "ðŸ”¨ Running: $CMD"
          $CMD
          
          sleep 2
          
          # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
          ORIG_FILE="build/lvgl_micropy_${{ matrix.config.board }}-${{ matrix.config.variant }}-${{ matrix.config.flash }}.bin"
          
          if [ ! -f "$ORIG_FILE" ]; then
            echo "âŒ Firmware not found at: $ORIG_FILE"
            echo "Available files in build/:"
            ls -la build/ 2>/dev/null || echo "No build directory"
            exit 1
          fi
          
          echo "âœ… Found firmware: $ORIG_FILE"
          
          # å‡†å¤‡æ–°æ–‡ä»¶å
          TIMESTAMP=$(date +"%Y%m%d%H%M")
          NEW_FILE="LVGL_MicroPython-${{ matrix.config.board }}_${{ matrix.config.variant }}_N${{ matrix.config.flash }}_${{ matrix.config.display }}"
          
          if [ -n "${{ matrix.config.indev }}" ] && [ "${{ matrix.config.indev }}" != "none" ]; then
            NEW_FILE="${NEW_FILE}_${{ matrix.config.indev }}"
          fi
          
          NEW_FILE="${NEW_FILE}-${TIMESTAMP}.bin"
          
          # ç›´æŽ¥é‡å‘½ååŽŸå§‹æ–‡ä»¶ï¼ˆæœ€ç®€å•ï¼‰
          mv "$ORIG_FILE" "build/$NEW_FILE"
          
          echo "ðŸ“„ Renamed to: $NEW_FILE"
          echo "ðŸ“ File size: $(stat -c%s "build/$NEW_FILE") bytes"
          
          # è®¾ç½®è·¯å¾„å˜é‡ï¼ˆç›¸å¯¹äºŽå·¥ä½œç©ºé—´æ ¹ç›®å½•ï¼‰
          echo "FIRMWARE_PATH=${{ env.LVGL }}/build/$NEW_FILE" >> $GITHUB_ENV
          echo "FIRMWARE_NAME=$NEW_FILE" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware artifact
        if: steps.build.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FIRMWARE_NAME }}
          path: ${{ env.FIRMWARE_PATH }}  # ä½¿ç”¨ç»å¯¹è·¯å¾„
          retention-days: 30

      - name: Create build info
        run: |
          echo "## Build Information" > build_info.md
          echo "### Configuration" >> build_info.md
          echo "- **Board:** ${{ matrix.config.board }}" >> build_info.md
          echo "- **Variant:** ${{ matrix.config.variant }}" >> build_info.md
          echo "- **Flash Size:** ${{ matrix.config.flash }}MB" >> build_info.md
          echo "- **Display Driver:** ${{ matrix.config.display }}" >> build_info.md
          echo "- **Touch Driver:** ${{ matrix.config.indev }}" >> build_info.md
          echo "- **Build Date:** $(date)" >> build_info.md
          echo "" >> build_info.md
          
          if [ "${{ steps.build.outputs.status }}" = "success" ]; then
            echo "### âœ… Build Successful" >> build_info.md
            echo "Firmware: ${{ env.FIRMWARE_NAME }}" >> build_info.md
            echo "" >> build_info.md
            echo "### Flash Command" >> build_info.md
            echo '```bash' >> build_info.md
            echo "esptool.py --chip esp32s3 -p /dev/ttyUSB0 -b 460800 \\" >> build_info.md
            echo "  write_flash --flash_size ${{ matrix.config.flash }}MB \\" >> build_info.md
            echo "  0x0 ${{ env.FIRMWARE_NAME }}" >> build_info.md
            echo '```' >> build_info.md
          else
            echo "### âŒ Build Failed" >> build_info.md
          fi

      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.config.board }}
          path: build_info.md
          retention-days: 7
