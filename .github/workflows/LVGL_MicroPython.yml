name: LVGL_MicroPython For ESP32

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  LVGL: lvgl_micropython
  LVGL_REPO: https://github.com/lvgl-micropython/lvgl_micropython.git
  TZ: Asia/Shanghai

jobs:
  build-firmware:
    name: Build LVGL_MicroPython
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        config:
          # ÈÖçÁΩÆÂàóË°®ÔºöÊ†πÊçÆ‰Ω†ÁöÑÈúÄË¶ÅÈÄâÊã©
          - board: ESP32_GENERIC_S3
            variant: SPIRAM_OCT
            flash: 8
            display: ST7789
            indev: FT6X36
            
          - board: ESP32_GENERIC_S3
            variant: SPIRAM_OCT
            flash: 16
            display: ST7789
            indev: FT6X36
            
          - board: ESP32_GENERIC
            variant: SPIRAM
            flash: 4
            display: ILI9341
            indev: FT6X36
            
          - board: ESP32_GENERIC
            variant: SPIRAM
            flash: 16
            display: ILI9341
            indev: FT6X36

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git wget flex bison gperf \
            python3 python3-pip python3-venv \
            cmake ninja-build ccache \
            libffi-dev libssl-dev dfu-util \
            libusb-1.0-0
          sudo timedatectl set-timezone "${{ env.TZ }}"

      - name: Clone LVGL MicroPython
        run: |
          git clone --recursive --depth=1 "${{ env.LVGL_REPO }}" "${{ env.LVGL }}"

      - name: Build firmware
        id: build
        run: |
          cd "${{ env.LVGL }}"
          
          echo "üì¶ Building firmware..."
          echo "Board: ${{ matrix.config.board }}"
          echo "Variant: ${{ matrix.config.variant }}"
          echo "Flash: ${{ matrix.config.flash }}MB"
          echo "Display: ${{ matrix.config.display }}"
          echo "Touch: ${{ matrix.config.indev }}"
          
          # ÊûÑÂª∫ÂëΩ‰ª§
          BUILD_CMD="python3 make.py esp32 \
            BOARD=${{ matrix.config.board }} \
            BOARD_VARIANT=${{ matrix.config.variant }} \
            --flash-size=${{ matrix.config.flash }} \
            DISPLAY=${{ matrix.config.display }}"
          
          # Â¶ÇÊûúÊúâËß¶Êë∏È©±Âä®ÔºåÊ∑ªÂä†Âà∞ÂëΩ‰ª§
          if [ -n "${{ matrix.config.indev }}" ] && [ "${{ matrix.config.indev }}" != "none" ]; then
            BUILD_CMD="$BUILD_CMD INDEV=${{ matrix.config.indev }}"
          fi
          
          echo "üî® Running: $BUILD_CMD"
          $BUILD_CMD
          
          # Á≠âÂæÖÊñá‰ª∂ÂÜôÂÖ•ÂÆåÊàê
          sleep 3
          
          echo "üîç Searching for firmware file..."
          
          # Âú®Â§ö‰∏™‰ΩçÁΩÆÊü•ÊâæÂõ∫‰ª∂Êñá‰ª∂
          FIRMWARE_PATH=""
          
          # 1. È¶ñÂÖàÂú® build ÁõÆÂΩïÊü•Êâæ
          if [ -d "build" ]; then
            echo "Checking build directory..."
            FIRMWARE_FILE=$(ls -t build/*.bin 2>/dev/null | head -1)
            if [ -n "$FIRMWARE_FILE" ] && [ -f "$FIRMWARE_FILE" ]; then
              FIRMWARE_PATH="$FIRMWARE_FILE"
              echo "‚úÖ Found in build directory: $FIRMWARE_PATH"
            fi
          fi
          
          # 2. Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÔºåÂú® lib/micropython ÁõÆÂΩïÊü•Êâæ
          if [ -z "$FIRMWARE_PATH" ]; then
            echo "Checking micropython directories..."
            MPY_BUILD_DIR="lib/micropython/ports/esp32/build-${{ matrix.config.board }}-${{ matrix.config.variant }}"
            if [ -d "$MPY_BUILD_DIR" ]; then
              FIRMWARE_FILE=$(ls -t "$MPY_BUILD_DIR"/*.bin 2>/dev/null | head -1)
              if [ -n "$FIRMWARE_FILE" ] && [ -f "$FIRMWARE_FILE" ]; then
                FIRMWARE_PATH="$FIRMWARE_FILE"
                echo "‚úÖ Found in micropython directory: $FIRMWARE_PATH"
              fi
            fi
          fi
          
          # 3. ‰ΩøÁî® find ÂëΩ‰ª§ÂÖ®Â±ÄÊêúÁ¥¢
          if [ -z "$FIRMWARE_PATH" ]; then
            echo "Searching globally..."
            FIRMWARE_FILE=$(find . -name "*.bin" -type f -newer /dev/null 2>/dev/null | grep -i "lvgl\|firmware" | head -1)
            if [ -z "$FIRMWARE_FILE" ]; then
              FIRMWARE_FILE=$(find . -name "*.bin" -type f | head -1)
            fi
            
            if [ -n "$FIRMWARE_FILE" ] && [ -f "$FIRMWARE_FILE" ]; then
              FIRMWARE_PATH="$FIRMWARE_FILE"
              echo "‚úÖ Found globally: $FIRMWARE_PATH"
            fi
          fi
          
          # Ê£ÄÊü•ÊòØÂê¶ÊâæÂà∞Âõ∫‰ª∂
          if [ -z "$FIRMWARE_PATH" ] || [ ! -f "$FIRMWARE_PATH" ]; then
            echo "‚ùå ERROR: Firmware file not found!"
            echo "Current directory: $(pwd)"
            echo "Directory contents:"
            ls -la
            echo "Build directory contents:"
            ls -la build/ 2>/dev/null || echo "No build directory"
            exit 1
          fi
          
          # ÂàõÂª∫ÊúÄÁªàËæìÂá∫ÁõÆÂΩï
          mkdir -p firmware_output
          
          # ÁîüÊàêÊñ∞ÁöÑÊñá‰ª∂Âêç
          TIMESTAMP=$(date +"%Y%m%d%H%M")
          ORIG_NAME=$(basename "$FIRMWARE_PATH")
          NEW_NAME="LVGL_MicroPython-${{ matrix.config.board }}_${{ matrix.config.variant }}_N${{ matrix.config.flash }}_${{ matrix.config.display }}"
          
          if [ -n "${{ matrix.config.indev }}" ] && [ "${{ matrix.config.indev }}" != "none" ]; then
            NEW_NAME="${NEW_NAME}_${{ matrix.config.indev }}"
          fi
          
          NEW_NAME="${NEW_NAME}-${TIMESTAMP}.bin"
          
          # Â§çÂà∂Êñá‰ª∂Âà∞ËæìÂá∫ÁõÆÂΩï
          cp "$FIRMWARE_PATH" "firmware_output/$NEW_NAME"
          
          echo "üìÑ Original: $ORIG_NAME"
          echo "üìÑ Renamed: $NEW_NAME"
          echo "üìè File size: $(stat -c%s "firmware_output/$NEW_NAME") bytes"
          
          # ËÆæÁΩÆËæìÂá∫ÂèòÈáè
          echo "FIRMWARE_PATH=firmware_output/$NEW_NAME" >> $GITHUB_ENV
          echo "FIRMWARE_NAME=$NEW_NAME" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware artifact
        if: steps.build.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FIRMWARE_NAME }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30

      - name: Create build info
        if: always()
        run: |
          echo "## Build Information" > build_info.md
          echo "### Configuration" >> build_info.md
          echo "- **Board:** ${{ matrix.config.board }}" >> build_info.md
          echo "- **Variant:** ${{ matrix.config.variant }}" >> build_info.md
          echo "- **Flash Size:** ${{ matrix.config.flash }}MB" >> build_info.md
          echo "- **Display Driver:** ${{ matrix.config.display }}" >> build_info.md
          echo "- **Touch Driver:** ${{ matrix.config.indev }}" >> build_info.md
          echo "- **Build Date:** $(date)" >> build_info.md
          echo "" >> build_info.md
          
          if [ "${{ steps.build.outputs.status }}" = "success" ]; then
            echo "### ‚úÖ Build Successful" >> build_info.md
            echo "Firmware: ${{ env.FIRMWARE_NAME }}" >> build_info.md
            echo "" >> build_info.md
            echo "### Flash Command" >> build_info.md
            echo '```bash' >> build_info.md
            echo "esptool.py --chip esp32s3 -p /dev/ttyUSB0 -b 460800 \\" >> build_info.md
            echo "  write_flash --flash_size ${{ matrix.config.flash }}MB \\" >> build_info.md
            echo "  0x0 ${{ env.FIRMWARE_NAME }}" >> build_info.md
            echo '```' >> build_info.md
          else
            echo "### ‚ùå Build Failed" >> build_info.md
          fi

      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.config.board }}-${{ matrix.config.variant }}
          path: build_info.md
          retention-days: 7

  summary:
    name: Build Summary
    runs-on: ubuntu-22.04
    needs: [build-firmware]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üèÅ LVGL MicroPython Build Completed"
          echo "All firmware artifacts have been uploaded."
          echo "Download them from the 'Artifacts' section."
